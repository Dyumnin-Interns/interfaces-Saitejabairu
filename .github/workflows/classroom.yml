name: Autograding Tests
on: [push, repository_dispatch]
permissions:
  checks: write
  actions: read
  contents: read

jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y iverilog gtkwave
        pip install cocotb==1.8.0 pytest

    - name: Run original test
      id: dut-test
      run: |
        make -C tests clean
        make -C tests
        mv tests/results.xml tests/orig.xml

    - name: Run delayed DUT test
      id: delayed-dut
      run: |
        cp hdl/delayed_dut.v hdl/dut.v
        make -C tests clean
        make -C tests
        mv tests/results.xml tests/delayed_dut.xml

    - name: Upload waveforms
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: simulation-waveforms
        path: tests/*.vcd

    - name: Autograding Reporter
      uses: classroom-resources/autograding-grading-reporter@v1
      env:
        DUT-TEST_RESULTS: "${{steps.dut-test.outputs.result}}"
        DELAYED-DUT_RESULTS: "${{steps.delayed-dut.outputs.result}}"
      with:
        runners: dut-test,delayed-dut
